# Azure Container Apps Dockerfile
# Optimized for Azure Container Apps deployment

FROM agnohq/python:3.12

ARG USER=app
ARG APP_DIR=/app
ENV APP_DIR=${APP_DIR}

# Environment variables for Azure Container Apps
ENV PYTHONUNBUFFERED=1
ENV PORT=8000

# Install ca-certificates for SSL connections to Azure PostgreSQL
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && groupadd -g 61000 ${USER} \
    && useradd -g 61000 -u 61000 -ms /bin/bash -d ${APP_DIR} ${USER}

WORKDIR ${APP_DIR}

# Copy requirements-linux.txt
COPY requirements-linux.txt ./

# Install requirements with PyTorch CPU index
RUN uv pip sync requirements-linux.txt --system \
    --index-strategy unsafe-best-match \
    --index-url https://download.pytorch.org/whl/cpu \
    --extra-index-url https://pypi.org/simple/

# Copy project files
COPY . .

# Set permissions for the /app directory
RUN chown -R ${USER}:${USER} ${APP_DIR}

# Switch to non-root user
USER ${USER}

# Azure Container Apps uses dynamic port assignment
# But we'll expose 8000 as default
EXPOSE 8000

# Updated entrypoint for Azure Container Apps
# Uses PORT environment variable if provided, defaults to 8000
ENTRYPOINT ["sh", "-c", "uvicorn api.main:app --host 0.0.0.0 --port ${PORT:-8000}"]